---
description: Destiny2 tModLoader mod development pipeline—architecture, conventions, anti-patterns, and data flow
alwaysApply: true
---

# Destiny2 Mod Development Pipeline

## 1. Architecture & File Layout

| Path | Namespace | Purpose |
|------|-----------|---------|
| `Common/` | `Destiny2.Common.*` | Base classes, global systems, shared logic |
| `Common/VFX/` | `Destiny2.Common.VFX` | VFX systems (SolarVFXSystem, KineticTremorsVFXSystem), Destiny2Shaders |
| `Content/` | `Destiny2.Content.*` | Concrete weapons, projectiles, tiles, buffs |
| `Assets/Perks/` | — | Perk icon PNGs (key = perk class name without "Perk") |
| `Assets/Elements/` | — | Element icons |
| `Assets/Ammo/` | — | Primary, Special, Heavy icons |
| `Assets/AutoloadedEffects/Shaders/` | — | Shader .fx (Luminance autoloads); Primitives/ for bullet trails |

**Where to add:** New weapon → `Content/Weapons/`. New projectile → `Content/Projectiles/`. New perk → `Common/Perks/` (add to FramePerks or WeaponPerks or new file). New VFX system → `Common/VFX/`. New shader → add .fx under `Assets/AutoloadedEffects/Shaders/` (or Primitives/) and a constant in `Destiny2Shaders`. New buff → `Content/Buffs/PerkBuffs.cs` (perk display buffs) or new file if non-perk.

**Weapon base:** `Destiny2WeaponStats.cs` + `Destiny2WeaponItem.Perks.cs` (partial classes)
**Frames:** `ScoutRifleWeaponItem`, `HandCannonWeaponItem`, `AutoRifleWeaponItem` (in Common/Weapons/)

---

## 2. Weapon System

### Base class: Destiny2WeaponItem

- `BaseStats` (abstract) → `Destiny2WeaponStats` struct (Range, Stability, ReloadSpeed, RoundsPerMinute, Magazine)
- `WeaponElement` → `Destiny2WeaponElement` (Kinetic, Arc, Solar, Void, Stasis, Strand) via `GetDamageClass()`
- `AmmoType` → `Destiny2AmmoType` (Primary, Special, Heavy)

### Perk flow for concrete weapons

```csharp
// In Content/Weapons/SomeWeapon.cs
protected override void RollFramePerk()
{
    SetFramePerk(nameof(RapidFireFramePerk));  // or AdaptiveFramePerk, etc.
}

protected override void RollPerks()
{
    string barrel = RollFrom(nameof(HammerForgedRiflingPerk), nameof(SmallborePerk));
    string magazine = RollFrom(nameof(AlloyMagPerk), nameof(ExtendedMagPerk));
    string majorOne = RollFrom(nameof(RapidHitPerk));
    string majorTwo = RollFrom(nameof(RampagePerk), nameof(IncandescentPerk));
    SetPerks(barrel, magazine, majorOne, majorTwo);
}
```

- **SetFramePerk(string)** — sets frame perk key
- **SetPerks(params string[])** — replaces perkKeys list; keys = `nameof(SomePerk)`
- **RollFrom(params string[])** — returns one random key
- **GetPerks()** — returns `IEnumerable<Destiny2Perk>` from Destiny2PerkSystem by perkKeys

### Data persistence

- `SaveData(TagCompound)` / `LoadData(TagCompound)` — perkKeys, currentMagazine, reload state, customStats, framePerkKey, catalystPerkKey, elementOverride
- `NetSend(BinaryWriter)` / `NetReceive(BinaryReader)` — same data for multiplayer
- `Clone(Item)` — must copy all perk timers and state (outlawTimer, rampageTimer, etc.)

### Perk stat application

- `ApplyActivePerkStats(ref Destiny2WeaponStats)` — modifies stats based on active timers (Outlaw, RapidHit, Frenzy, Onslaught, FeedingFrenzy, Adagio, DynamicSway)

---

## 3. Projectile System

### Bullet (Content/Projectiles/Bullet.cs)

- **Hitscan via vanilla Colliding:** Uses `Colliding()` with `CheckAABBvLineCollision` (start = Center - velocity, end = Center)
- **No CCD in AI:** Bullet no longer does manual CCD; vanilla handles collision
- **localAI[0]/[1]** — last Center (kept in sync; trail uses `Projectile.oldPos`)
- **OnSpawn:** Get `sourceItem` from `EntitySource_ItemUse` or `EntitySource_ItemUse_WithAmmo` → `sourceItem?.ModItem is Destiny2WeaponItem`
- **Weapon data:** maxFalloffTiles, weaponElement, DamageType from weaponItem
- **ai[0]** — element ID
- **hasDealtDamage** — prevents double-handling in OnHitNPC (vanilla may fire alongside Colliding)
- **Trail:** Shader-based. **Drawing is in PostDrawTiles** via `BulletDrawSystem` (Common/VFX) — same path as Kinetic Tremors so Luminance primitives work. Bullet caches positions in `trailCache`; `GetDrawData()` returns trail + element + center + rotation; `BulletDrawSystem.PostDrawTiles` loops active bullets and calls `Bullet.DrawTrail` + `Bullet.DrawCore` (Luminance `RenderTrail` + `RenderQuad`). Bullet `PreDraw` only returns false (no draw there). Shader names in `Destiny2Shaders` (Common/VFX).
- **Constants:** MaxDistance 1200f, Speed 32f, ExtraUpdates 3, TrailPoints 24

### ExplosiveShadowSlug (Content/Projectiles/ExplosiveShadowSlug.cs)

- Malfeasance projectile; sticks to target, detonates
- Same OnSpawn pattern; same maxFalloffTiles
- Uses `IsStickingToTarget`, different AI for stick/detonate

### Destiny2PerkProjectile (GlobalProjectile)

- **OnSpawn:** Resolves source via `GetSourceWeaponItem(source)` or fallback to `owner.HeldItem`
- **Perk attachment:** `weaponItem.GetPerks()` → iterates, adds to `perks` list, sets bools (hasVorpal, hasIncandescent, etc.)
- **IsTrackedProjectile:** type == Bullet or ExplosiveShadowSlug, and Mod.Name == "Destiny2"
- Perks that need projectile logic: Vorpal, Outlaw, RapidHit, KillClip, Frenzy, FourthTimes, Rampage, Onslaught, KineticTremors, Adagio, TargetLock, FeedingFrenzy, Incandescent, TheRightChoice, EyesUpGuardian, ArmorPiercingRounds

---

## 4. Perk System

### Destiny2Perk (abstract)

- `Key` (default: GetType().Name), `IsFrame`, `SlotType`
- `ModifyStats(ref Destiny2WeaponStats)`, `OnProjectileHitNPC(...)` — optional overrides

### Registration (Destiny2PerkSystem.OnModLoad)

```csharp
Register(new RapidHitPerk());
Register(new IncandescentPerk());
// Frame perks go to FramePerks list; others to Perks
```

### Perk logic locations

- **GlobalProjectile:** Destiny2PerkProjectile — hit detection, damage mods, spawning child projectiles (Eyes Up Guardian, Kinetic Tremors)
- **GlobalNPC:** ScorchGlobalNPC (Scorch DoT, ignite at 100 stacks, Incandescent explosion), KineticTremorsGlobalNPC
- **Weapon item partial:** Destiny2WeaponItem.Perks.cs — timers (outlawTimer, rampageTimer, etc.), `AppendPerkHudEntries`
- **ModProjectile:** ExplosiveShadowSlug — stick/detonate logic for Explosive Shadow

### Perk HUD

- `Destiny2WeaponItem.AppendPerkHudEntries(List<PerkHudEntry>)` — builds list of (IconTexture, Timer, MaxTimer, Stacks, ShowStacks)
- Icon path: `Assets/Perks/{perkKey}.png` (e.g. RampagePerk → Rampage.png)
- Destiny2HudSystem.PostDrawInterface — draws magazine, reload bar, perk buff panel

---

## 5. Damage & tML API

### No damage variance

- `Destiny2NoDamageVarianceProjectile` (GlobalProjectile)
- `ModifyHitNPC` → `modifiers.DamageVariationScale *= 0f`
- **Do NOT** use `MultipliableFloat` or raw float assignment for damage/knockback — tML changed; use HitModifiers

### Damage type

- `weaponElement.GetDamageClass()` → `Destiny2ElementDamageClass` (custom damage classes)
- Projectile.DamageType set in OnSpawn from weapon

### Obsolete members

- `ModProjectile.Kill(int)` and `OnKill(int)` — if overriding, add `[Obsolete]` to match base when tML warns

---

## 6. Reference Mods & Original Code

- **Reference only:** Use Luminance, NoxusBoss, Calamity, Starlight River (and similar) **only as references** to understand APIs, patterns, and techniques. Read their code to learn *how* things work (e.g. primitive vertex format, shader loading, trail rendering).
- **No copied code:** Do NOT copy-paste code from reference mods. Implement **original** logic, shaders, and VFX in Destiny2. Use their public/documented APIs (e.g. Luminance’s `PrimitiveRenderer.RenderTrail`, `ShaderManager.GetShader`) as intended; write your own HLSL, C# behavior, and assets.

---

## 7. Anti-Patterns (Do NOT)

- **MultipliableFloat:** Old API; use `modifiers.DamageVariationScale *= 0f` (HitModifiers)
- **StarlightRiver shader loader:** `Mod.File`, `FileEntry` do not exist in tML
- **Incandescent/Ignition VFX:** `SolarVFXSystem` uses Luminance's `PrimitiveRenderer.RenderQuad`, `ShaderManager` (QuadRenderer), `ScreenShakeSystem`, procedural bloom/ring textures, dust for fire motes and embers.
- **Crit spot system:** Removed; if ever reintroduced: Precision AR 1.75, Adaptive AR 1.75, Adaptive HC 1.79, Precision HC 1.55, Heavy Burst HC 2.2
- **ExplosiveShadowGlobalItem:** Deleted; Explosive Shadow lives in WeaponPerks (ExplosiveShadowPerk), ExplosiveShadowGlobalNPC, Destiny2PerkProjectile + ExplosiveShadowSlug

---

## 8. Conventions

- `sealed class` for leaf types (Trustee, Bullet, ScorchGlobalNPC)
- XML `<summary>` on public/important methods
- `if (Main.dedServ) return;` for client-only (dust, draw)
- `if (Main.netMode == NetmodeID.MultiplayerClient) return;` for server-only (spawning, state changes)
- Constants at top of class
- Element colors: Void (196,0,240), Strand (55,218,100), Stasis (51,91,196), Solar (236,85,0), Arc (7,208,255), Kinetic (255,248,163)

---

## 9. Precision Multipliers (Reference)

Used by frames via `GetPrecisionMultiplier()`; crit system removed but values preserved for future use:

| Frame | Multiplier |
|-------|------------|
| Precision Auto Rifle | 1.75 |
| Khvostov / Adaptive Auto Rifle | 1.75 |
| Adaptive Hand Cannon | 1.79 |
| Precision Hand Cannon, Malfeasance | 1.55 |
| Heavy Burst Hand Cannon | 2.2 |

---

## 10. Build & Run

**Luminance dependency:** Destiny2 strongly references Luminance (`modReferences` in build.txt, ProjectReference to `../Luminance`). Luminance is cloned in `ModSources/Luminance`. Users must have Luminance enabled in tModLoader. Build Luminance first (or it builds as dependency).

**Build:** `dotnet build` (from project root). tML targets auto-package the mod into `bin/Debug/net8.0/`.

**Run tModLoader:** `Start-Process "C:\Program Files (x86)\Steam\steamapps\common\tModLoader\start-tModLoader.bat" -WorkingDirectory "C:\Program Files (x86)\Steam\steamapps\common\tModLoader\"` (PowerShell)  
— or double-click `start-tModLoader.bat` in the tML install folder.  
ModSources are loaded from the workspace; enable the Destiny2 mod in-game.

---

## 11. Build / Errors

- **MSB3073 / exit -2147450730:** tML build step crashed; check mod code for runtime exceptions during load
- **NETSDK1127:** .NET targeting pack missing → dotnet restore or SDK install
- **Asset not found:** Use mod-scoped paths; .xnb must be built and included in mod output

---

## 12. VFX / Shader Reference (Calamity, Starlight River)

General-purpose reference for implementing VFX. Use as inspiration, not copy-paste.

**Mod paths:** `ModSources/CalamityModPublic-1.4.4/CalamityModPublic-1.4.4`, `ModSources/StarlightRiver-master/StarlightRiver-master`

---

### A. Choosing a VFX approach

| Use case | Approach | References |
|----------|----------|------------|
| **Explosions, bursts** | Particle (CustomDraw), sprite draws, dust burst, Luminance primitives | DetailedExplosion, SolarVFXSystem (Luminance RenderQuad) |
| **Projectile trails** | PrimitiveRenderer.RenderTrail + MiscShader | MythrilFlare, SuicideBomberDemon, WulfrumHook |
| **Telegraphs, AoE indicators** | Sprite + MiscShader (radial gradient) | CircularAoETelegraph, CircularGradientWithEdge |
| **Shields, force fields** | Sprite + MiscShader (noise, rings) | SupremeShieldShader, RoverDriveShield |
| **Full-screen effects** | Filters.Scene, BaseRenderer | DistortionPointHandler, HolyInfernoRenderer |
| **Simple glows** | SpriteBatch + BlendState.Additive, BasicTint | Vanilla ForceField, procedural soft circle |
| **Distortion / screen warp** | Filters.Scene + custom params | DistortionPointHandler |

---

### B. Shader loading & registration

**Load:** `ModContent.Request<Effect>("ModName/Effects/ShaderName", ImmediateLoad).Value` — tML compiles .fx → .xnb at build. Calamity uses `Instance.Assets.Request<Effect>("Effects/Path", ImmediateLoad)`.

**Register MiscShader (sprite-based):**  
`GameShaders.Misc["ModName:Key"] = new MiscShaderData(new Ref<Effect>(shader), "PassName")`  
Use with `GameShaders.Misc["ModName:Key"].Apply()` before SpriteBatch.Draw.

**Register ScreenShader (full-screen):**  
`Filters.Scene["Key"] = new Filter(new ScreenShaderData(ref, "PassName"), priority)`  
`Filters.Scene.Activate("Key")` / `Deactivate("Key")`. Set custom params via `GetShader().Shader.Parameters["name"].SetValue(...)`.

---

### C. Shader types by effect (Calamity)

| Shader | Use case | HLSL notes |
|--------|----------|------------|
| **CircularGradientWithEdge** | AoE telegraph, circular glow | `dist = length(coords-0.5)*2`, crop circle, bright edge |
| **CircularAoETelegraph** | Countdown telegraph | Same as above; `uSaturation` = completion (0→1) |
| **ImpFlameTrail** | Flame trails | `bloomOpacity = pow(sin(coords.y*PI), n)`, noise scroll, trail fade |
| **HellBall** | Full-screen ball, explosions | Noise sampling, `blowUpPower`/`blowUpSize`, fake fresnel `pow(dist,6)` |
| **SupremeShieldShader** | Force fields, shields | Noise + ring, `distanceRatio`, `inverseLerp` for ring alpha |
| **BasicTint** | Generic colored glow | Simple tint pass |
| **ExobladeSlashShader** | Melee trails | Multi-sampler noise, UV distortion, fire streak |
| **ExobladePierceShader** | Pierce / impact marks | Bloom falloff, noise scroll, energy lerp |

---

### D. Particle systems

**Calamity Particle** (`Particles/Particle.cs`): Extend `Particle`, set `Texture`, `UseAdditiveBlend`, `SetLifetime`, `UseCustomDraw`. Override `Update()`, optional `CustomDraw()`. `GeneralParticleHandler.SpawnParticle(particle)`. Batched by blend mode.

**DetailedExplosion pattern:** `LifetimeCompletion` for lerp, `PiecewiseAnimation`/easing, `opacity = sin(PI/2 + completion*PI/2)` for fade-out. `Lighting.AddLight`. Scale from original to final.

**CircularSmearVFX:** Minimal particle—position, color, rotation, scale, lifetime. Additive blend. No custom draw.

---

### E. Primitive trails (Calamity vs Luminance)

**PrimitiveRenderer.RenderTrail(positions, settings, pointsToCreate):**  
Positions in world space (screenPosition subtracted automatically). Needs 4+ points for smoothing.

**Calamity:** `PrimitiveSettings` with `MiscShaderData Shader`; e.g. `GameShaders.Misc["CalamityMod:ImpFlameTrail"]`.

**Destiny2 (Luminance):** Use `Destiny2Shaders` (Common/VFX) for shader access: `Destiny2Shaders.GetBulletTrailShader(element)`, `Destiny2Shaders.TryGet(Destiny2Shaders.SolarExplosionShader, out var shader)`, `Destiny2Shaders.IsReady`. Luminance's `PrimitiveRenderer.RenderTrail` with `PrimitiveSettings(..., Shader: Destiny2Shaders.GetBulletTrailShader(element))`. Shaders live in `Assets/AutoloadedEffects/Shaders/Primitives/` (BulletTrailArc, BulletTrailSolar, Void, Stasis, Strand). Vertex format: `float3 TextureCoordinates`, with `coords.y = (coords.y - 0.5) / input.TextureCoordinates.z + 0.5` in pixel shader (see Luminance primitive README).

**Usage:** In projectile/NPC PreDraw or Draw, pass `Projectile.oldPos` (or segment list). Shader receives primitive UVs (trail completion = X, width = Y).

---

### F. Render targets (Calamity BaseRenderer)

**BaseRenderer:** Extend, implement `Layer`, `ShouldDraw`, `DrawToTarget`. Draw to `MainTarget` (screen-sized). Manager calls `DrawToTarget` then draws target to screen. Use for layered effects (HolyInferno border).

**DrawToTarget pattern:** Load textures, set shader params (`radius`, `anchorPoint`, `screenPosition`, etc.), `spriteBatch.End()` then `Begin(Immediate, Additive, shader)`, draw fullscreen quad, `ExitShaderRegion()`.

---

### G. SpriteBatch & draw hooks

**PostDrawTiles:** SpriteBatch is NOT active. Begin/End your own batch. Do NOT leave batch Begun—`DrawSuperSpecialProjectiles` runs next and calls Begin. Same for other mod draw hooks: check vanilla order.

**BlendState:** `BlendState.Additive` for glows, `AlphaBlend` default. `SpriteSortMode.Immediate` when using shaders that need per-draw Apply.

**Procedural texture:** Create `Texture2D` on main thread (e.g. first draw). Radial gradient: loop pixels, `dist = Distance(center)`, `alpha = smoothstep` or `1 - saturate((dist-radius)/softness)`.

---

### H. Starlight River (obsolete patterns)

**ShaderLoader:** Uses `TmodFile`, `FileEntry`—do NOT copy. Use `ModContent.Request<Effect>`.

**DistortionPointHandler:** Points with position, intensity, progress; delegate-based Update. Arrays passed to shader. Activate filter when points exist, set params each frame. Pattern is useful; loader is not.

**IDrawPrimitive / IDrawAdditive:** Interfaces for custom draw ordering. `DrawPrimitives()`, `DrawAdditive(spriteBatch)`.

---

## 13. Luminance & Noxus Design Patterns (Adopted Workflow)

### A. Integrated Shader Drawing (The `IDrawsWithShader` Pattern)
Instead of manually restarting `SpriteBatch` in every projectile's `PreDraw`:
1.  **Interface:** Entities implement `IDrawsWithShader` (properties: `LayeringPriority`, `ShaderShouldDrawAdditively`, method: `DrawWithShader(SpriteBatch)`).
2.  **System:** A central `ModSystem` (like `InterfacedEntityDrawSystem`) hooks `DrawProjectiles`/`DrawNPCs`.
    - It iterates all active entities implementing the interface.
    - Restarts `SpriteBatch` **once** with `Immediate` sort mode and `AlphaBlend` (or `Additive`).
    - Calls `DrawWithShader` for each.
3.  **Benefit:** cleaner individual classes, fewer batch flushes, correct layering by priority.

### B. Primitives vs. Sprites
- **Primitives (`PrimitiveRenderer`):** For trails, shockwaves, beams. Use `PostDrawTiles` (via System) or `PreDraw` (if strictly ordered). Logic is separate from the `Projectile.AI`.
- **Sprites:** Use `IDrawsWithShader` if they need complex shader application.

### C. Particles
- **Inheritance:** Create particles by inheriting from `Luminance.Core.Graphics.Particle`.
- **Texture:** Use `AtlasTexture` (from `AtlasManager`) or standard textures.
- **Visuals:** Use procedural logic (Update) to animate scale/color/rotation rather than frame-by-frame sheets where possible.

### D. Rendering Philosophy
- **Decoupled:** AI (`Projectile.cs`) handles logic. Rendering (`DrawSystem`) handles visuals.
- **Procedural:** Prefer math-driven visuals (Sine/Noise on radius/color) over large sprite sheets for effects (e.g. `SolarVFXSystem`).

---

## 14. Elemental Visual Identity (Bullet & VFX Guide)

### ARC
- **Core:** Thin, needle-like, longer than wide. White-hot tip, cyan/blue body.
- **Trail:** Discontinuous lightning filaments; jagged, snapping bursts.
- **Motion:** Fast, flickering, sudden brightness spikes.
- **Impact:** Star-shaped flash + forked micro-arcs.

### SOLAR
- **Core:** Rounded/teardrop pellet. White/yellow center → orange/red edge. Soft/blurry bloom.
- **Trail:** Smooth flame plume, curling backward, continuous fluid motion.
- **Motion:** Heavy, hot, molten.
- **Impact:** Expanding fire bloom + drifting embers.

### VOID
- **Core:** Dense orb, dark center, purple shell, faint glowing rim.
- **Trail:** Suction trail; particles curve *inward*, subtle, ominous.
- **Motion:** Slow but massive/powerful.
- **Impact:** Silent implosion, inward collapse.

### STASIS
- **Core:** Sharp crystal shard/spike. Pale icy blue + white highlights. Hard, faceted edges (no blur).
- **Trail:** Tiny crystalline dust/shards.
- **Motion:** Precise, rigid, "fired icicle".
- **Impact:** Instant freeze flash + radial crystal shards.

### STRAND
- **Core:** Elongated knot of thread. Neon green/yellow-green. Organic/wavering edges.
- **Trail:** Elastic ribbons; stretch, loop, recoil used as trail.
- **Motion:** Whip-fast, alive, "living tether".
- **Impact:** Threads snap outward, binding/wrapping.
