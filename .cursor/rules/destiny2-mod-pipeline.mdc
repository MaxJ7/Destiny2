---
description: Destiny2 tModLoader mod development pipeline—architecture, conventions, anti-patterns, and data flow
alwaysApply: true
---

# Destiny2 Mod Development Pipeline

## 1. Architecture & File Layout

| Path | Namespace | Purpose |
|------|-----------|---------|
| `Common/` | `Destiny2.Common.*` | Base classes, global systems, shared logic |
| `Content/` | `Destiny2.Content.*` | Concrete weapons, projectiles, tiles, buffs |
| `Assets/Perks/` | — | Perk icon PNGs (key = perk class name without "Perk") |
| `Assets/Elements/` | — | Element icons |
| `Assets/Ammo/` | — | Primary, Special, Heavy icons |

**Weapon base:** `Destiny2WeaponStats.cs` + `Destiny2WeaponItem.Perks.cs` (partial classes)
**Frames:** `ScoutRifleWeaponItem`, `HandCannonWeaponItem`, `AutoRifleWeaponItem` (in Common/Weapons/)

---

## 2. Weapon System

### Base class: Destiny2WeaponItem

- `BaseStats` (abstract) → `Destiny2WeaponStats` struct (Range, Stability, ReloadSpeed, RoundsPerMinute, Magazine)
- `WeaponElement` → `Destiny2WeaponElement` (Kinetic, Arc, Solar, Void, Stasis, Strand) via `GetDamageClass()`
- `AmmoType` → `Destiny2AmmoType` (Primary, Special, Heavy)

### Perk flow for concrete weapons

```csharp
// In Content/Weapons/SomeWeapon.cs
protected override void RollFramePerk()
{
    SetFramePerk(nameof(RapidFireFramePerk));  // or AdaptiveFramePerk, etc.
}

protected override void RollPerks()
{
    string barrel = RollFrom(nameof(HammerForgedRiflingPerk), nameof(SmallborePerk));
    string magazine = RollFrom(nameof(AlloyMagPerk), nameof(ExtendedMagPerk));
    string majorOne = RollFrom(nameof(RapidHitPerk));
    string majorTwo = RollFrom(nameof(RampagePerk), nameof(IncandescentPerk));
    SetPerks(barrel, magazine, majorOne, majorTwo);
}
```

- **SetFramePerk(string)** — sets frame perk key
- **SetPerks(params string[])** — replaces perkKeys list; keys = `nameof(SomePerk)`
- **RollFrom(params string[])** — returns one random key
- **GetPerks()** — returns `IEnumerable<Destiny2Perk>` from Destiny2PerkSystem by perkKeys

### Data persistence

- `SaveData(TagCompound)` / `LoadData(TagCompound)` — perkKeys, currentMagazine, reload state, customStats, framePerkKey, catalystPerkKey, elementOverride
- `NetSend(BinaryWriter)` / `NetReceive(BinaryReader)` — same data for multiplayer
- `Clone(Item)` — must copy all perk timers and state (outlawTimer, rampageTimer, etc.)

### Perk stat application

- `ApplyActivePerkStats(ref Destiny2WeaponStats)` — modifies stats based on active timers (Outlaw, RapidHit, Frenzy, Onslaught, FeedingFrenzy, Adagio, DynamicSway)

---

## 3. Projectile System

### Bullet (Content/Projectiles/Bullet.cs)

- **Hitscan via vanilla Colliding:** Uses `Colliding()` with `CheckAABBvLineCollision` (start = Center - velocity, end = Center)
- **No CCD in AI:** Bullet no longer does manual CCD; vanilla handles collision
- **localAI[0]/[1]** — last position (for dust trail)
- **OnSpawn:** Get `sourceItem` from `EntitySource_ItemUse` or `EntitySource_ItemUse_WithAmmo` → `sourceItem?.ModItem is Destiny2WeaponItem`
- **Weapon data:** maxFalloffTiles, weaponElement, DamageType from weaponItem
- **ai[0]** — element ID
- **hasDealtDamage** — prevents double-handling in OnHitNPC (vanilla may fire alongside Colliding)
- **Trail:** `SpawnDustSegment(lastPosition, Center, element)` — dust-based; do NOT reintroduce shader trail (was reverted, caused crashes)
- **Constants:** MaxDistance 1200f, DustSpacing 4f, Speed 32f, ExtraUpdates 3

### ExplosiveShadowSlug (Content/Projectiles/ExplosiveShadowSlug.cs)

- Malfeasance projectile; sticks to target, detonates
- Same OnSpawn pattern; same maxFalloffTiles
- Uses `IsStickingToTarget`, different AI for stick/detonate

### Destiny2PerkProjectile (GlobalProjectile)

- **OnSpawn:** Resolves source via `GetSourceWeaponItem(source)` or fallback to `owner.HeldItem`
- **Perk attachment:** `weaponItem.GetPerks()` → iterates, adds to `perks` list, sets bools (hasVorpal, hasIncandescent, etc.)
- **IsTrackedProjectile:** type == Bullet or ExplosiveShadowSlug, and Mod.Name == "Destiny2"
- Perks that need projectile logic: Vorpal, Outlaw, RapidHit, KillClip, Frenzy, FourthTimes, Rampage, Onslaught, KineticTremors, Adagio, TargetLock, FeedingFrenzy, Incandescent, TheRightChoice, EyesUpGuardian, ArmorPiercingRounds

---

## 4. Perk System

### Destiny2Perk (abstract)

- `Key` (default: GetType().Name), `IsFrame`, `SlotType`
- `ModifyStats(ref Destiny2WeaponStats)`, `OnProjectileHitNPC(...)` — optional overrides

### Registration (Destiny2PerkSystem.OnModLoad)

```csharp
Register(new RapidHitPerk());
Register(new IncandescentPerk());
// Frame perks go to FramePerks list; others to Perks
```

### Perk logic locations

- **GlobalProjectile:** Destiny2PerkProjectile — hit detection, damage mods, spawning child projectiles (Eyes Up Guardian, Kinetic Tremors)
- **GlobalNPC:** ScorchGlobalNPC (Scorch DoT, ignite at 100 stacks, Incandescent explosion), KineticTremorsGlobalNPC
- **Weapon item partial:** Destiny2WeaponItem.Perks.cs — timers (outlawTimer, rampageTimer, etc.), `AppendPerkHudEntries`
- **ModProjectile:** ExplosiveShadowSlug — stick/detonate logic for Explosive Shadow

### Perk HUD

- `Destiny2WeaponItem.AppendPerkHudEntries(List<PerkHudEntry>)` — builds list of (IconTexture, Timer, MaxTimer, Stacks, ShowStacks)
- Icon path: `Assets/Perks/{perkKey}.png` (e.g. RampagePerk → Rampage.png)
- Destiny2HudSystem.PostDrawInterface — draws magazine, reload bar, perk buff panel

---

## 5. Damage & tML API

### No damage variance

- `Destiny2NoDamageVarianceProjectile` (GlobalProjectile)
- `ModifyHitNPC` → `modifiers.DamageVariationScale *= 0f`
- **Do NOT** use `MultipliableFloat` or raw float assignment for damage/knockback — tML changed; use HitModifiers

### Damage type

- `weaponElement.GetDamageClass()` → `Destiny2ElementDamageClass` (custom damage classes)
- Projectile.DamageType set in OnSpawn from weapon

### Obsolete members

- `ModProjectile.Kill(int)` and `OnKill(int)` — if overriding, add `[Obsolete]` to match base when tML warns

---

## 6. Anti-Patterns (Do NOT)

- **MultipliableFloat:** Old API; use `modifiers.DamageVariationScale *= 0f` (HitModifiers)
- **StarlightRiver shader loader:** `Mod.File`, `FileEntry` do not exist in tML
- **Incandescent/Ignition VFX:** `SolarVFXSystem` uses Luminance's `PrimitiveRenderer.RenderQuad`, `ShaderManager` (QuadRenderer), `ScreenShakeSystem`, procedural bloom/ring textures, dust for fire motes and embers.
- **Crit spot system:** Removed; if ever reintroduced: Precision AR 1.75, Adaptive AR 1.75, Adaptive HC 1.79, Precision HC 1.55, Heavy Burst HC 2.2
- **ExplosiveShadowGlobalItem:** Deleted; Explosive Shadow lives in Destiny2PerkProjectile + ExplosiveShadowSlug

---

## 7. Conventions

- `sealed class` for leaf types (Trustee, Bullet, ScorchGlobalNPC)
- XML `<summary>` on public/important methods
- `if (Main.dedServ) return;` for client-only (dust, draw)
- `if (Main.netMode == NetmodeID.MultiplayerClient) return;` for server-only (spawning, state changes)
- Constants at top of class
- Element colors: Void (196,0,240), Strand (55,218,100), Stasis (51,91,196), Solar (236,85,0), Arc (7,208,255), Kinetic (255,248,163)

---

## 8. Precision Multipliers (Reference)

Used by frames via `GetPrecisionMultiplier()`; crit system removed but values preserved for future use:

| Frame | Multiplier |
|-------|------------|
| Precision Auto Rifle | 1.75 |
| Khvostov / Adaptive Auto Rifle | 1.75 |
| Adaptive Hand Cannon | 1.79 |
| Precision Hand Cannon, Malfeasance | 1.55 |
| Heavy Burst Hand Cannon | 2.2 |

---

## 9. Build & Run

**Luminance dependency:** Destiny2 strongly references Luminance (`modReferences` in build.txt, ProjectReference to `../Luminance`). Luminance is cloned in `ModSources/Luminance`. Users must have Luminance enabled in tModLoader. Build Luminance first (or it builds as dependency).

**Build:** `dotnet build` (from project root). tML targets auto-package the mod into `bin/Debug/net8.0/`.

**Run tModLoader:** `Start-Process "C:\Program Files (x86)\Steam\steamapps\common\tModLoader\start-tModLoader.bat" -WorkingDirectory "C:\Program Files (x86)\Steam\steamapps\common\tModLoader\"` (PowerShell)  
— or double-click `start-tModLoader.bat` in the tML install folder.  
ModSources are loaded from the workspace; enable the Destiny2 mod in-game.

---

## 10. Build / Errors

- **MSB3073 / exit -2147450730:** tML build step crashed; check mod code for runtime exceptions during load
- **NETSDK1127:** .NET targeting pack missing → dotnet restore or SDK install
- **Asset not found:** Use mod-scoped paths; .xnb must be built and included in mod output

---

## 11. VFX / Shader Reference (Calamity, Starlight River)

General-purpose reference for implementing VFX. Use as inspiration, not copy-paste.

**Mod paths:** `ModSources/CalamityModPublic-1.4.4/CalamityModPublic-1.4.4`, `ModSources/StarlightRiver-master/StarlightRiver-master`

---

### A. Choosing a VFX approach

| Use case | Approach | References |
|----------|----------|------------|
| **Explosions, bursts** | Particle (CustomDraw), sprite draws, dust burst, Luminance primitives | DetailedExplosion, SolarVFXSystem (Luminance RenderQuad) |
| **Projectile trails** | PrimitiveRenderer.RenderTrail + MiscShader | MythrilFlare, SuicideBomberDemon, WulfrumHook |
| **Telegraphs, AoE indicators** | Sprite + MiscShader (radial gradient) | CircularAoETelegraph, CircularGradientWithEdge |
| **Shields, force fields** | Sprite + MiscShader (noise, rings) | SupremeShieldShader, RoverDriveShield |
| **Full-screen effects** | Filters.Scene, BaseRenderer | DistortionPointHandler, HolyInfernoRenderer |
| **Simple glows** | SpriteBatch + BlendState.Additive, BasicTint | Vanilla ForceField, procedural soft circle |
| **Distortion / screen warp** | Filters.Scene + custom params | DistortionPointHandler |

---

### B. Shader loading & registration

**Load:** `ModContent.Request<Effect>("ModName/Effects/ShaderName", ImmediateLoad).Value` — tML compiles .fx → .xnb at build. Calamity uses `Instance.Assets.Request<Effect>("Effects/Path", ImmediateLoad)`.

**Register MiscShader (sprite-based):**  
`GameShaders.Misc["ModName:Key"] = new MiscShaderData(new Ref<Effect>(shader), "PassName")`  
Use with `GameShaders.Misc["ModName:Key"].Apply()` before SpriteBatch.Draw.

**Register ScreenShader (full-screen):**  
`Filters.Scene["Key"] = new Filter(new ScreenShaderData(ref, "PassName"), priority)`  
`Filters.Scene.Activate("Key")` / `Deactivate("Key")`. Set custom params via `GetShader().Shader.Parameters["name"].SetValue(...)`.

---

### C. Shader types by effect (Calamity)

| Shader | Use case | HLSL notes |
|--------|----------|------------|
| **CircularGradientWithEdge** | AoE telegraph, circular glow | `dist = length(coords-0.5)*2`, crop circle, bright edge |
| **CircularAoETelegraph** | Countdown telegraph | Same as above; `uSaturation` = completion (0→1) |
| **ImpFlameTrail** | Flame trails | `bloomOpacity = pow(sin(coords.y*PI), n)`, noise scroll, trail fade |
| **HellBall** | Full-screen ball, explosions | Noise sampling, `blowUpPower`/`blowUpSize`, fake fresnel `pow(dist,6)` |
| **SupremeShieldShader** | Force fields, shields | Noise + ring, `distanceRatio`, `inverseLerp` for ring alpha |
| **BasicTint** | Generic colored glow | Simple tint pass |
| **ExobladeSlashShader** | Melee trails | Multi-sampler noise, UV distortion, fire streak |
| **ExobladePierceShader** | Pierce / impact marks | Bloom falloff, noise scroll, energy lerp |

---

### D. Particle systems

**Calamity Particle** (`Particles/Particle.cs`): Extend `Particle`, set `Texture`, `UseAdditiveBlend`, `SetLifetime`, `UseCustomDraw`. Override `Update()`, optional `CustomDraw()`. `GeneralParticleHandler.SpawnParticle(particle)`. Batched by blend mode.

**DetailedExplosion pattern:** `LifetimeCompletion` for lerp, `PiecewiseAnimation`/easing, `opacity = sin(PI/2 + completion*PI/2)` for fade-out. `Lighting.AddLight`. Scale from original to final.

**CircularSmearVFX:** Minimal particle—position, color, rotation, scale, lifetime. Additive blend. No custom draw.

---

### E. Primitive trails (Calamity)

**PrimitiveRenderer.RenderTrail(positions, settings, pointsToCreate):**  
Positions in world space (screenPosition subtracted automatically). Needs 4+ points for smoothing.

**PrimitiveSettings:** `VertexWidthFunction`, `VertexColorFunction`, `VertexOffsetFunction`, `Smoothen`, `Pixelate`, `MiscShaderData Shader`. Example: `new PrimitiveSettings(WidthFn, ColorFn, offsetFn, smoothen: true, shader: GameShaders.Misc["CalamityMod:ImpFlameTrail"])`.

**Usage:** In projectile/NPC PreDraw or Draw, pass `Projectile.oldPos` or segment list. Shader receives primitive UVs (trail completion = X, width = Y).

---

### F. Render targets (Calamity BaseRenderer)

**BaseRenderer:** Extend, implement `Layer`, `ShouldDraw`, `DrawToTarget`. Draw to `MainTarget` (screen-sized). Manager calls `DrawToTarget` then draws target to screen. Use for layered effects (HolyInferno border).

**DrawToTarget pattern:** Load textures, set shader params (`radius`, `anchorPoint`, `screenPosition`, etc.), `spriteBatch.End()` then `Begin(Immediate, Additive, shader)`, draw fullscreen quad, `ExitShaderRegion()`.

---

### G. SpriteBatch & draw hooks

**PostDrawTiles:** SpriteBatch is NOT active. Begin/End your own batch. Do NOT leave batch Begun—`DrawSuperSpecialProjectiles` runs next and calls Begin. Same for other mod draw hooks: check vanilla order.

**BlendState:** `BlendState.Additive` for glows, `AlphaBlend` default. `SpriteSortMode.Immediate` when using shaders that need per-draw Apply.

**Procedural texture:** Create `Texture2D` on main thread (e.g. first draw). Radial gradient: loop pixels, `dist = Distance(center)`, `alpha = smoothstep` or `1 - saturate((dist-radius)/softness)`.

---

### H. Starlight River (obsolete patterns)

**ShaderLoader:** Uses `TmodFile`, `FileEntry`—do NOT copy. Use `ModContent.Request<Effect>`.

**DistortionPointHandler:** Points with position, intensity, progress; delegate-based Update. Arrays passed to shader. Activate filter when points exist, set params each frame. Pattern is useful; loader is not.

**IDrawPrimitive / IDrawAdditive:** Interfaces for custom draw ordering. `DrawPrimitives()`, `DrawAdditive(spriteBatch)`.
